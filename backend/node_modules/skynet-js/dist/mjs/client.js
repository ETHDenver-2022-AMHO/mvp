import axios from "axios";
import { uploadFile, uploadDirectory, uploadDirectoryRequest, uploadFileRequest } from "./upload";
import { downloadFile, downloadFileHns, getSkylinkUrl, getHnsUrl, getHnsresUrl, getMetadata, getFileContent, getFileContentHns, getFileContentRequest, openFile, openFileHns, resolveHns, } from "./download";
import { getJSON as fileGetJSON } from "./file";
import { getJSON, setJSON } from "./skydb";
import { getEntry, getEntryUrl, getEntryLink, setEntry, postSignedEntry } from "./registry";
import { addUrlQuery, defaultPortalUrl, makeUrl } from "./utils/url";
import { loadMySky } from "./mysky";
import { extractDomain, getFullDomainUrl } from "./mysky/utils";
import { trimSuffix } from "./utils/string";
/**
 * The Skynet Client which can be used to access Skynet.
 */
export class SkynetClient {
    /**
     * The Skynet Client which can be used to access Skynet.
     *
     * @class
     * @param [initialPortalUrl] The initial portal URL to use to access Skynet, if specified. A request will be made to this URL to get the actual portal URL. To use the default portal while passing custom options, pass "".
     * @param [customOptions] Configuration for the client.
     */
    constructor(initialPortalUrl = "", customOptions = {}) {
        // Set methods (defined in other files).
        // Upload
        this.uploadFile = uploadFile;
        this.uploadFileRequest = uploadFileRequest;
        this.uploadDirectory = uploadDirectory;
        this.uploadDirectoryRequest = uploadDirectoryRequest;
        // Download
        this.downloadFile = downloadFile;
        this.downloadFileHns = downloadFileHns;
        this.getSkylinkUrl = getSkylinkUrl;
        this.getHnsUrl = getHnsUrl;
        this.getHnsresUrl = getHnsresUrl;
        this.getMetadata = getMetadata;
        this.getFileContent = getFileContent;
        this.getFileContentHns = getFileContentHns;
        this.getFileContentRequest = getFileContentRequest;
        this.openFile = openFile;
        this.openFileHns = openFileHns;
        this.resolveHns = resolveHns;
        // MySky
        this.extractDomain = extractDomain;
        this.getFullDomainUrl = getFullDomainUrl;
        this.loadMySky = loadMySky;
        // File API
        this.file = {
            getJSON: fileGetJSON.bind(this),
        };
        // SkyDB
        this.db = {
            getJSON: getJSON.bind(this),
            setJSON: setJSON.bind(this),
        };
        // SkyDB helpers
        this.registry = {
            getEntry: getEntry.bind(this),
            getEntryUrl: getEntryUrl.bind(this),
            getEntryLink: getEntryLink.bind(this),
            setEntry: setEntry.bind(this),
            postSignedEntry: postSignedEntry.bind(this),
        };
        if (initialPortalUrl === "") {
            // Portal was not given, use the default portal URL. We'll still make a request for the resolved portal URL.
            initialPortalUrl = defaultPortalUrl();
        }
        else {
            // Portal was given, don't make the request for the resolved portal URL.
            this.givenPortalUrl = initialPortalUrl;
        }
        this.initialPortalUrl = initialPortalUrl;
        this.customOptions = customOptions;
    }
    /**
     * Make the request for the API portal URL.
     *
     * @returns - A promise that resolves when the request is complete.
     */
    /* istanbul ignore next */
    async initPortalUrl() {
        if (!SkynetClient.resolvedPortalUrl) {
            SkynetClient.resolvedPortalUrl = new Promise((resolve, reject) => {
                this.executeRequest({
                    ...this.customOptions,
                    method: "head",
                    url: this.initialPortalUrl,
                    endpointPath: "/",
                }).then((response) => {
                    if (typeof response.headers === "undefined") {
                        reject(new Error("Did not get 'headers' in response despite a successful request. Please try again and report this issue to the devs if it persists."));
                    }
                    const portalUrl = response.headers["skynet-portal-api"];
                    if (!portalUrl) {
                        reject(new Error("Could not get portal URL for the given portal"));
                    }
                    resolve(trimSuffix(portalUrl, "/"));
                });
            });
        }
        await SkynetClient.resolvedPortalUrl;
        return;
    }
    /**
     * Returns the API portal URL. Makes the request to get it if not done so already.
     *
     * @returns - the portal URL.
     */
    /* istanbul ignore next */
    async portalUrl() {
        if (this.givenPortalUrl) {
            return this.givenPortalUrl;
        }
        // Make the request if needed and not done so.
        this.initPortalUrl();
        return await SkynetClient.resolvedPortalUrl; // eslint-disable-line
    }
    /**
     * Creates and executes a request.
     *
     * @param config - Configuration for the request.
     * @returns - The response from axios.
     * @throws - Will throw if unimplemented options have been passed in.
     */
    async executeRequest(config) {
        var _a;
        // Build the URL.
        let url = config.url;
        if (!url) {
            const portalUrl = await this.portalUrl();
            url = makeUrl(portalUrl, config.endpointPath, (_a = config.extraPath) !== null && _a !== void 0 ? _a : "");
        }
        if (config.query) {
            url = addUrlQuery(url, config.query);
        }
        // Build headers.
        const headers = { ...config.headers };
        if (config.customUserAgent) {
            headers["User-Agent"] = config.customUserAgent;
        }
        if (config.customCookie) {
            headers["Cookie"] = config.customCookie;
        }
        const auth = config.APIKey ? { username: "", password: config.APIKey } : undefined;
        /* istanbul ignore next */
        const onUploadProgress = config.onUploadProgress &&
            function (event) {
                const progress = event.loaded / event.total;
                // Need the if-statement or TS complains.
                if (config.onUploadProgress)
                    config.onUploadProgress(progress, event);
            };
        return axios({
            url,
            method: config.method,
            data: config.data,
            headers,
            auth,
            onUploadProgress,
            transformRequest: config.transformRequest,
            transformResponse: config.transformResponse,
            maxContentLength: Infinity,
            maxBodyLength: Infinity,
            // Allow cross-site cookies.
            withCredentials: true,
        });
    }
}
